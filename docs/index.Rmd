---
title: "Assesment"
output: html_document
date: "2024-11-01"
---
# Pregnancy termination and contraception trend over 8 year period in Scotland

Birth control availability was a liberating step towards women having full control of their reproduction. However, this liberation started shifting towards new means of constraints by society putting a huge burden on women as a sole responsibility bearers when it comes to pregnancy prevention. Female contraceptives being the most effective birth control means that women have to put up with extensive list of side effects with no equivalent male alternatives. In recent years, health risks associated with hormonal contraceptive usage started being discussed more [https://www.sciencedirect.com/science/article/pii/S0277953621005797#bib55]. Social media plays a significant role in shaping opinions about hormonal contraceptives and in turn their decline in various western countries [https://www.sciencedirect.com/science/article/pii/S0277953623004380#bib15]. Female contraceptives have been critiqued for their extensive list of side effects while dismissive attitude of general health practitioners when it comes to a contraceptive choice has sparked distrust. On the one hand, such discussions highlight important issues and encourage informed choice; on the other hand, it creates a space for misinformation and skewed experiences getting more representation than the general ones. 

Nevertheless, female contraceptives remain being the most reliable way to prevent unwanted pregnancy [reference]. The changes in birth control usage probe a question in how this correlates with further measures to terminate pregnancy. This report will explore female contraceptive trends in Scotland between 2018 and 2023 and look how this trend correlated with pregnancy termination statistics.


### AIMS of this report:

1. Is there a national trend in female contraceptives in Scotland between year 2018 and 2023
2. Do the trends of short-term (oral, injections, and implants) and long-term (IUD and coil) contraceptives differ;
3. Is there a correlation between contraceptive trend and pregnancy termination trend nation wide and within health boards.



```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
```


```{r Used packages, include=FALSE}
library(tidyverse)
library(janitor) # cleaning data
library(gt) # tables
library(here) # directory structure (will be useful later)
library(vroom)
library(stringr)
library(pals)
library(patchwork)
```

## Data used in the report

Abortion and prescription data used in this report has been obtained from [Public Health Scotland](https://www.opendata.nhs.scot/dataset). For showing the contraceptive usage trend in 6 years all age data was used that includes females under 20 to females over 40. 

To ensure comparable figures between different boards the number of pregnancy termination events was normalised per 1000 of women in the health board in accordance to 2022 Cencus data. Only women of biological reproductive age were included as they are the most likely to be included in the statistic. The chosen respoductive age span was from 13 (average age of first menstruation) to 50 (average age of natural menopause) [https://academic.oup.com/hropen/article/2022/2/hoac005/6527206#356986178].



```{r Heatlh board names and population, include=FALSE}
health_boards <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names() %>% 
  select(hb, hb_name)

# Combined Boards for NHS Orkney, NHS Shetland and NHS Western Isles
other_health_boards <- read_csv("https://www.opendata.nhs.scot/dataset/65402d20-f0f1-4cee-a4f9-a960ca560444/resource/8f0c3067-7b10-44c6-af36-37f87a9e6efa/download/grouped-geography.csv") %>% 
  clean_names() %>%
  rename(hb_name = "grouped_geography_name", hb = "grouped_geography") %>% 
  select(hb_name, hb)

health_boards <- bind_rows(health_boards, other_health_boards)

health_board_population <- read_csv(here( "data", "UV103_age_health_board_census.csv"), skip = 10) %>% 
  clean_names() %>% 
  rename(hb_name = "health_board_area_2019") %>% 
  filter(age %in% c(13:50), sex == "Female") %>% 
  group_by(hb_name) %>% 
  summarise(female_repro_population = sum(count)) %>% 
  mutate(hb_name = paste("NHS", hb_name)) 


boards_to_sum <- c("NHS Orkney", "NHS Shetland", "NHS Western Isles")

# Calculate the population for the target board
islands_population <- health_board_population %>%
  filter(hb_name %in% boards_to_sum) %>%
  summarise(total_population = sum(female_repro_population, na.rm = TRUE)) %>%
  pull(total_population)


health_board_population <- full_join(health_board_population, health_boards, by = "hb_name") %>% 
  mutate(hb_name = factor(hb_name, labels = c(
  "NHS Ayrshire and Arran" = "Ayrshire and Arran",
  "NHS Borders" = "Borders",
  "NHS Dumfries and Galloway" = "Dumfries and Galloway",
  "NHS Fife" = "Fife",
  "NHS Forth Valley" = "Forth Valley",
  "NHS Grampian" = "Grampian",
  "NHS Greater Glasgow and Clyde" = "Greater Glasgow and Clyde",
  "NHS Highland" = "Highland",
  "NHS Island Boards" = "Islands",
  "NHS Lanarkshire" = "Lanarkshire",
  "NHS Lothian" = "Lothian",
  "NHS Orkney" = "Orkney",
  "NHS Shetland" = "Shetland",
  "NHS Tayside" = "Tayside",
  "NHS Western Isles" = "Western Isles"
))) %>% 
  mutate(female_repro_population = case_when(hb_name == "Islands" ~ islands_population,
      TRUE ~ female_repro_population))
  



```



```{r Abortion data, include=FALSE}
#data on abortion 2000-2023
abortion_data <- read_csv("https://www.opendata.nhs.scot/dataset/d684d4a5-f7ae-4a1a-ae8d-adf55304274e/resource/342f9627-dfdd-41f5-a27c-0a3c7bcb8672/download/residence_age_2023.csv") %>% 
  clean_names() %>% 
  rename(hb = "hbr", year = "yearof_termination") %>% 
  filter(age_group == "All Ages") %>% 
  select(year, hb, numberof_terminations)

abortion_data <- left_join(abortion_data, health_board_population, by = "hb")  %>% 
  mutate(abortion_per_1000_women = numberof_terminations/female_repro_population * 1000) %>% 
  filter(!is.na(hb_name))


```

Prescription data has been filtered based on BNF item code. Codes beginning with 0703 and 21040 were selected as representing contraceptive medication and devices. 

As for pregnancy termination data, number of items count was normalised per 1000 of women of reproductive age in the health board based on 2022 Cencus data. 

```{r URLs for prescription data, include=FALSE}
#prescription data between 2018 and 2023 in a names vector

prescription_data_urls <- c(
# List for 2023
  "dec_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/00cdf8d7-f784-4e87-894c-34f2540ea6ab/download/pitc202312.csv",
  "nov_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/21d11fed-a494-4e30-9bb6-46143c3b9530/download/pitc202311.csv",
  "oct_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/94134438-db1d-4b8d-8f70-5e9b0e47bd03/download/pitc202310.csv",
  "sep_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/2d3d240f-1467-4a91-9f0e-769745650cb9/download/pitc202309.csv",
  "aug_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/72ca4ad2-0228-4672-9eb0-cc911e4a8ca7/download/pitc202308.csv",
  "jul_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7bb45ee6-6f1c-45f4-933b-958bdbe0ca4f/download/pitc202307.csv",
  "jun_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/66e9611a-fbea-45b2-9edd-351c388fd06d/download/pitc202306.csv",
  "may_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/a0cf1a9f-d8c3-4bda-a8d9-733897c4c288/download/pitc202305.csv",
  "apr_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/720699b0-7584-4ddb-9915-79b298189d1d/download/pitc202304.csv",
  "mar_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/8dd06c58-1a09-483a-8a01-5d68cfb8b38e/download/pitc202303.csv",
  "feb_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/ad6d7f4e-08fd-40ed-ad49-bf450d386f39/download/pitc202302.csv",
  "jan_2023" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/6caa7144-f0e4-4ab0-b9e4-8fa10c8edf1c/download/pitc202301.csv",

# List for 2022
  "jan_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/53a53d61-3b3b-4a12-888b-a788ce13db9c/download/pitc202201.csv",
  "feb_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/bd7aa5c9-d708-4d0b-9b28-a9d822c84e34/download/pitc202202.csv",
  "mar_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/a0ec3bf2-7339-413b-9c66-2891cfd7919f/download/pitc202203.csv",
  "apr_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7de8c908-86f8-45ac-b6a4-e21d1df30584/download/pitc202204.csv",
  "may_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/1b4e3200-b6e6-415f-b19a-b9ef927db1ab/download/pitc202205.csv",
  "jun_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/debeadd8-2bbb-4dd3-82de-831531bab2cb/download/pitc202206.csv",
  "jul_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/26ce66f1-e7f2-4c71-9995-5dc65f76ecfb/download/pitc202207.csv",
  "aug_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/49fa5784-be06-4015-bc6d-9b5db8726473/download/pitc202208.csv",
  "sep_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/9d0a518d-9d9c-4bcb-afd8-51f6abb7edf1/download/pitc202209.csv",
  "oct_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/bd7bc2cf-4de5-4711-bd5a-9e3b77305453/download/pitc202210.csv",
  "nov_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/023986c0-3bb2-43cb-84e8-2e0b3bb1f55f/download/pitc202211.csv",
  "dec_2022" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/00213ffa-941e-4389-9e6f-3bca8067da8c/download/pitc202212.csv",

# List for 2021
  "jan_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7722a6e6-a6b6-49ec-aa63-fdc4bc727f05/download/pitc202101.csv",
  "feb_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/3f5c55ac-1bcd-4c57-a7b6-12911f15239c/download/pitc202102.csv",
  "mar_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/df6fc708-5c50-4d57-a5c4-faa19a92c227/download/pitc202103.csv",
  "apr_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/51b7ad3f-6d52-4165-94f4-92e322656c85/download/pitc202104.csv",
  "may_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/167ffab7-a168-43d1-90c4-118aa955edfb/download/pitc202105.csv",
  "jun_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/05159d26-f504-47ce-9d33-29b739e666ea/download/pitc202106.csv",
  "jul_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/5c1cd207-1958-4105-923f-ab60983d3f90/download/pitc202107.csv",
  "aug_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/6cdae245-0423-4e6f-9e1c-dc9e129df3aa/download/pitc202108.csv",
  "sep_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/d7d1ada5-2763-4698-bf39-7bdb06f67377/download/pitc202109.csv",
  "oct_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/35cbc6b1-3462-4563-88ba-d57c03782534/download/pitc202110.csv",
  "nov_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/6ba23bd1-f53b-4946-bc79-00633239d08f/download/pitc202111.csv",
  "dec_2021" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/ad9e7b46-47fb-4d42-baad-f8e98e8f5936/download/pitc202112.csv",

# List for 2020
  "jan_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e5c841f2-3e16-428b-97db-0798ec7a5fb4/download/pitc202001.csv",
  "feb_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/af121e7c-4124-4955-92e9-a9580ccd469e/download/pitc202002.csv",
  "mar_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/9581bd8d-5568-4462-93a6-6d7bfbbe7cbc/download/pitc202003.csv",
  "apr_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/9cdc0526-21ab-43de-b832-bc032cd31b24/download/pitc202004.csv",
  "may_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f2ffa7b3-3f93-470a-8125-880afb9aafe0/download/pitc202005.csv",
  "jun_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/64131d22-ab47-43ff-9674-ebe8ed7edbd7/download/pitc202006.csv",
  "jul_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/80b6ddb1-f09b-4d76-9927-da1e118b01ff/download/pitc202007.csv",
  "aug_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/5fd5f56e-d1d2-4f22-b4f7-224fbd50dca3/download/pitc202008.csv",
  "sep_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e1b0cfdd-d184-4ebc-bd93-f1a10d84ead0/download/pitc202009.csv",
  "oct_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/83bf4892-d246-41f8-a6ca-d44d18e2a2ca/download/pitc202010.csv",
  "nov_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/ab8aa642-2562-4abb-a360-5c5f9e7e349c/download/pitc202011.csv",
  "dec_2020" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/0c033702-4d88-4f2d-989c-a709b1f4529e/download/pitc202012.csv",

# List for 2019
  "jan_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/3bd6e3cc-b8b7-493b-b6aa-f9fcadbb05d2/download/pitc201901.csv",
  "feb_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/3729a5c8-787a-46e3-ab7d-feed9aa91b4e/download/pitc201902.csv",
  "mar_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/87b21840-beb8-40fd-bad8-579643bc8b8b/download/pitc201903.csv",
  "apr_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/02197246-5d98-4ba9-b25d-218ac9cd91e6/download/pitc201904.csv",
  "may_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7479536b-0b95-43d6-9152-31bbd522e6b4/download/pitc201905.csv",
  "jun_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/6ea2f299-76bc-49cd-ab43-9228b601da5f/download/pitc201906.csv",
  "jul_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/6e3856e9-88cb-495a-8c8a-54b0460df950/download/pitc201907.csv",
  "aug_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/5c667230-4201-4a09-949d-3e6cc3a4ec19/download/pitc201908.csv",
  "sep_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/ab3c15a9-44da-4a85-bb7a-58a8ce11f3d8/download/pitc201909.csv",
  "oct_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/55d93898-5382-4a59-a42e-bbc68f48b217/download/pitc201910.csv",
  "nov_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/eeee4a8f-3439-425a-aacd-58e536da90a0/download/pitc201911.csv",
  "dec_2019" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/fa276ad2-669a-472f-9c47-809f199fae21/download/pitc201912.csv",

# List for 2018
  "jan_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/82ef2c55-5a31-4759-ab9a-83b176e107f2/download/pitc201801.csv",
  "feb_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/1ae16a5f-aa26-4911-989b-ba4a6ab87037/download/pitc201802.csv",
  "mar_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/0b7bc1dd-9731-405b-a55e-656a8c996a58/download/pitc201803.csv",
  "apr_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e35aebd7-55be-4c8b-82b7-54d1ed946b91/download/pitc201804.csv",
  "may_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/a2a3d0fd-d9c4-48e9-a569-c5d8abdf76f0/download/pitc201805.csv",
  "jun_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/d73cfc66-3330-416f-8507-873db28eca5c/download/pitc201806.csv",
  "jul_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/fec5dfdb-96dc-4e87-b7a0-6ecf20ec86e9/download/pitc201807.csv",
  "aug_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/592f3b58-2da8-4cc7-b4ab-e0eb0f16aa3f/download/pitc201808.csv",
  "sep_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/bd18b099-942d-42fb-9fa5-b947714381cd/download/pitc201809.csv",
  "oct_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/37e94a73-121e-443e-9564-2e1d9e36c5eb/download/pitc201810.csv",
  "nov_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/9cc56231-f184-4e29-a5ef-e6080bc78e93/download/pitc201811.csv",
  "dec_2018" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/c50ed972-34e8-4cd6-8d2e-349e875c3ffa/download/pitc201812.csv",
 
# List for 2017 
  "jan_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/3def845e-c830-4b73-8e02-e42adcde5afa/download/pitc201701.csv",
  "feb_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f7a00faf-49ec-4a99-9686-e52b2d1572c4/download/pitc201702.csv",
  "mar_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/06c958d6-bae7-4d1b-9b62-88db123dc7b6/download/pitc201703.csv",
  "apr_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/78ff3279-2486-497c-968c-256a12631088/download/pitc201704.csv",
  "may_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/014bf682-7413-4418-abc6-233e145dd454/download/pitc201705.csv",
  "jun_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/13042cf7-fa4e-464c-aa9f-18c5213fb7b0/download/pitc201706.csv",
  "jul_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/44bc24dd-3a8e-4056-8ee2-eb903bc352ac/download/pitc201707.csv",
  "aug_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/ff0da464-d78f-4394-add2-101e78820932/download/pitc201708.csv",
  "sep_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/106c27b7-4615-4a14-a7d9-8dc22f86dbd2/download/pitc201709.csv",
  "oct_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/01cdd69a-049a-46cf-a618-75b5f93422f1/download/pitc201710.csv",
  "nov_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/0d9b6b7d-bd94-4d72-8806-22025edcdeeb/download/pitc201711.csv",
  "dec_2017" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/a39b254a-ab6a-41d5-a920-5ff34bdb9f6b/download/pitc201712.csv",

# List for 2016
  "jan_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7c487db9-f450-4319-8b18-4b825380692b/download/pitc201601.csv",
  "feb_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/0727befa-5530-4c1d-aff0-ccb7554eff7a/download/pitc201602.csv",
  "mar_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/20ad9575-4bd7-4bf4-af41-fd36071e2301/download/pitc201603.csv",
  "apr_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e44eb789-b8e0-41d9-a264-eba18b2d2473/download/pitc201604.csv",
  "may_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/90ebb5ed-bc22-4bbc-8915-d55ae9d9906e/download/pitc201605.csv",
  "jun_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/a636862a-77e0-4c97-ba97-268578534a8e/download/pitc201606.csv",
  "jul_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/c12c905b-3a2d-4b7a-b5d2-8c359b786beb/download/pitc201607.csv",
  "aug_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/bbd1d028-b9c6-4a28-b579-eafcaaa44703/download/pitc201608.csv",
  "sep_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/2e0d6f14-3752-4c42-9a02-34d867132737/download/pitc201609.csv",
  "oct_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f22c20c1-6066-4f7d-a939-3ae654d1467a/download/pitc201610.csv",
  "nov_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/5d421ba3-ccba-4d98-9772-e2e042b29a0f/download/pitc201611.csv",
  "dec_2016" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/597ea4bc-f733-45b6-8a60-5d7a6ac4824c/download/pitc201612.csv"

)
```



```{r Data reading and cleaning, include=FALSE}
columns_needed_from_prescription <- c("BNFItemCode", "NumberOfPaidItems")

read_and_clean <- function(url) {
  # vroom used as a faster function for reading delimited files
  # only columns with prescription drug name, health board, and number of items paid selected to make loading onto R more memory efficient
    #since older data files have health board column named HBT2014 while newer have is named HBT, any_of() is used to select only the ones that exist in the file being read
  data <- vroom(url, col_select = any_of(c(columns_needed_from_prescription, "HBT", "HBT2014")), skip_empty_rows = TRUE)
  
 
  #data filtered for contraceptives (including contraceptive devices) only (based on the BNF code)
  data_filtered <- data %>%
  filter(str_starts(BNFItemCode, "0703") | str_starts(BNFItemCode, "21040")) %>% 
    clean_names()
  colnames(data_filtered)[3] ="hb"

  
  # assign function used to create a value with the name of the url from named list and assign read preprocessed data to that variable
name <- names(prescription_data_urls)[which(prescription_data_urls == url)] 
assign(name, data_filtered, envir = .GlobalEnv) 
}

lapply(prescription_data_urls, read_and_clean)
```

```{r Combine all prescription datases, include=FALSE}
#sum the number of items paid for by health board
add_year <- function(url) {
  name <- names(prescription_data_urls)[which(prescription_data_urls == url)] 
  data <- get(name) 
  data <- data %>% 
    add_column(year = as.numeric(str_extract_all(name, "\\d+")))
  
  
  object_name <- paste(name, "sum", sep = "_")
  assign(object_name, data, envir = .GlobalEnv) 
}


lapply(prescription_data_urls, add_year)

#join full prescription dataset with healh board names and populations of women of reproductive age
full_prescirption_dataset <- bind_rows(mget(paste(names(prescription_data_urls), "sum", sep = "_")))
full_prescirption_dataset <- left_join(full_prescirption_dataset, health_board_population, by = "hb") 
  
```

The data was then further devided into long term contraceptives (IUD, coil, and implant) lasting several years and short term contraceptives that have to be taken regularly (oral tablets, cervical caps, and injections). The division was based on the BNF codes with 0703022P representing implants, 0703023 representing IUDs, and 210400002 representing copper coils. The remaining birth control was assigned to short-term cathegory. Same as abortion data the contraceptive data was normalised by women of reproductive age number in the health board for health board comparison.

```{r filter datasets to create long term and short term contraception datasets, include=FALSE}
long_term_contraception <- full_prescirption_dataset %>% 
  filter(str_detect(bnf_item_code, "0703022P|0703023|210400002")) %>% 
  group_by(year, hb_name, female_repro_population) %>% 
  summarise(sum_of_contraceptive_items = sum(number_of_paid_items, na.rm = TRUE)) %>% 
  mutate(contracep_items_per_1000_women = sum_of_contraceptive_items/female_repro_population*1000)

short_term_contraception <- full_prescirption_dataset %>% 
  filter(!str_detect(bnf_item_code, "0703022P|0703023|210400002")) %>% 
  group_by(year, hb_name, female_repro_population) %>% 
  summarise(sum_of_contraceptive_items = sum(number_of_paid_items, na.rm = TRUE)) %>% 
  mutate(contracep_items_per_1000_women = sum_of_contraceptive_items/female_repro_population*1000)

```


## Results

### Contraceptives trends

It has been shown that over the past 8 years there has been a decline in combined oral contraceptives being prescribed while the progesterone only pill prescriptions increased [https://srh.bmj.com/content/early/2024/05/24/bmjsrh-2024-202387]. While it shows that women preference might be shifting away from estrogen containing products it doesn't tell much about the overall trend in contraceptive usage. 

Figure 1 shows that there is a nationwide decline in birth control usage. There is a steep drop from pre-Covid to Covid year. It is hard to day whether the decline from year 2022 to 2023 is still due to Covid or if it represents a general trend of decline. Seeing that there was a downwards trend over pre-Covid years it could be suspected that this trend is continuing.

Interestingly, there is a sharp rise in contraceptive use in 2019.

```{r Figure 1, echo = FALSE, fig.cap='Fig 1. Gross prescription of contraceptives between 2016 and 2023'}
full_prescirption_dataset %>% 
  group_by(year) %>% 
  summarise(sum=sum(number_of_paid_items)) %>% 
  ggplot(aes(y=sum, x=year)) +
  geom_line(color="#69b3a2", linewidth=2) +
  theme_classic() +
  scale_x_continuous(breaks=c(2016:2023)) +
  theme(plot.title = element_text(size = 13, 
                                  hjust = 0,
                                  face = "bold", 
                                  margin = margin(10,10,10,10)), 
                                  axis.title.x = element_text(size = 11, margin=margin(10,0,0,0)), 
                                  axis.title.y = element_text(size = 11, margin=margin(0,10,0,0))) +
  labs(title = "Gross prescription of contraceptives between 2016 and 2023", x = "Year", y = "Number of items dispensed") +
  geom_vline(xintercept = 2020, color="grey", size=.5, linetype = "dashed") +
  geom_vline(xintercept = 2022, color="grey", size=.5, linetype = "dashed") +
  annotate(geom="text", x=2021, y=855000, 
             label="COVID period", colour = "#71797E") 
```

### Long-term and short term contraceptives

Women have multiple options when it comes to birth control, including short term options like oral pill and long-term options like IUD the coil. However, some women report feeling like they were not actually given a choice when it came to their birth control [https://www.sciencedirect.com/science/article/pii/S0277953623004380#bib15]. They report feeling like their GP's prescribed oral contraceptives by default. (With this coming to light women are taking control of their heatlh>>>>> 

To compare the trend of the long term and short term contraceptives all values were tormalised to 2018. It can be seen that short-term contraception is on a consistent decline over the past 8 years. Covid doesn't seem to have had much of an impact on these prescriptions. However, when it comes to long-term contraceptives it is clear that Covid hindered their use. That is likely because application of intravaginal devices and implants require medical professionals and during Covid clinics' had to focus their resources on emergency medical care. Overall, the rise in contraceptive use in 2019 seems to be influenced by both types of contraceptives.


```{r Figure 2, echo = FALSE, fig.cap='Fig. 2: Normalised prescription of long-term and short-term contraceptives'}
long_term_contraception_yearly_gross <- long_term_contraception %>% 
  group_by(year) %>% 
  summarise(sum=sum(sum_of_contraceptive_items)/29109)

short_term_contraception_yearly_gross <- short_term_contraception %>% 
   group_by(year) %>% 
  summarise(sum=sum(sum_of_contraceptive_items)/865093)
 
ggplot() +
  geom_line(data = long_term_contraception_yearly_gross, aes(y = sum, x = year), color = "#6D91F2", linewidth = 2) +
  geom_line(data = short_term_contraception_yearly_gross, aes(y = sum, x = year), color = "#6DF2A6", linewidth=2) +
  geom_vline(xintercept = 2020, color="grey", size=.5, linetype = "dashed") +
  geom_vline(xintercept = 2022, color="grey", size=.5, linetype = "dashed") +
  theme_classic() +
  scale_x_continuous(breaks=c(2016:2023)) +
  theme(plot.title = element_text(size = 13, 
                                  hjust = 0,
                                  face = "bold", 
                                  margin = margin(10,10,10,10)), 
                                  axis.title.x = element_text(size = 11, margin=margin(10,0,0,0)), 
                                  axis.title.y = element_text(size = 11, margin=margin(0,10,0,0))) +
  labs(title = "Normalised prescription of long-term and short-term contraceptives", x = "Year", y = "Normalised value of items dispensed per year") +
  annotate(geom="text", x=2021, y=1, 
             label="COVID period", colour = "#71797E") 

```

### Contraceptive and pregnancy termination trends 

As seen in previous sections there is a consistent decline in contraceptive dispensation which likely translates to their usage decline. Comparing this trend with pregnancy termination data show that there is negative correlation between these the two variables (R^2 = 0.7237). Figure 3 shows total contraceptive items dispensed plotted against total termination of pregnancy procedures for each year in 2016-2023 interval (pink dots) with a plotted linear regression line (green line). 



```{r}
contraception_data_hb <- full_prescirption_dataset %>% 
  group_by(year, hb_name, female_repro_population) %>% 
  summarise(total_contraceptives_per_hb=sum(number_of_paid_items)) %>% 
  mutate(contraceptives_per_1000_women = total_contraceptives_per_hb/female_repro_population) %>% 
  select(-female_repro_population)

islands_contraceptives <- full_prescirption_dataset %>% 
  filter(hb_name %in% c("Orkney", "Shetland", "Western Isles")) %>% 
  group_by(year) %>% 
  summarise(total_contraceptives_per_hb = sum(number_of_paid_items)) %>% 
  mutate(hb_name = "Islands")
  
contraception_data_hb <- bind_rows(contraception_data_hb,islands_contraceptives)  

abortion_data_hb <- abortion_data %>% 
  filter(year %in% c(2016:2023))


combined_data <- left_join(abortion_data_hb, contraception_data_hb, by = c("year", "hb_name")) %>%
  select(year, hb_name, abortion_per_1000_women, total_contraceptives_per_hb, contraceptives_per_1000_women, female_repro_population) %>% 
  mutate(contraceptives_per_1000_women = total_contraceptives_per_hb/female_repro_population*1000)

color_vector <- setNames(cols25(length(unique(combined_data$hb_name))), unique(combined_data$hb_name))

combined_data %>% 
  ggplot(aes(x = contraceptives_per_1000_women, y = abortion_per_1000_women, colour = hb_name)) +
  geom_point(size = 1) +
 geom_smooth(method = "lm", se = FALSE, aes(colour = hb_name)) +
  theme_classic() +
  theme(
    plot.title = element_text(size = 13, hjust = 0, face = "bold", margin = margin(10, 10, 10, 10)),
    axis.title.x = element_text(size = 11, margin = margin(10, 0, 0, 0)), 
    axis.title.y = element_text(size = 11, margin = margin(0, 10, 0, 0)),
    strip.text.x = element_text(size = 10, face = "bold")
  ) +
  labs( 
    title = "Contraceptives and Abortion Trends between 2016 and 2023", 
    x = "Total Contraceptives per year", 
    y = "Total Abortion per year" , colour = "Health Boards"
  ) +
  scale_colour_manual(values = color_vector) 

  


lm <- lm(data = combined_data, abortion_per_1000_women ~ contraceptives_per_1000_women)
summary(lm)
  
```




```{r Figure 3, echo=FALSE,fig.cap='Fig. 3: Correlation between termination of pregnancy occurence and contraceptive prescriptions'}
abortion_data_per_year <- abortion_data %>% 
  group_by(year) %>% 
  summarise(total_abortion_per_year = sum(numberof_terminations)) %>% 
  filter(year == c(2016:2023))

contraception_data <- full_prescirption_dataset %>% 
  group_by(year) %>% 
  summarise(total_contraceptives=sum(number_of_paid_items)) 

contraceptive_abortion_yearly <- full_join(contraception_data, abortion_data_per_year) 

contraceptive_abortion_yearly %>% 
  ggplot(aes(x = total_contraceptives, y = total_abortion_per_year)) +
  geom_point(colour = "#FF91C8", size = 2.5) +
  geom_smooth(method = "lm", colour = "#69B3A2", se = FALSE) +
  theme_classic() +
  theme(
    plot.title = element_text(size = 13, hjust = 0, face = "bold", margin = margin(10, 10, 10, 10)),
    axis.title.x = element_text(size = 11, margin = margin(10, 0, 0, 0)), 
    axis.title.y = element_text(size = 11, margin = margin(0, 10, 0, 0)),
    strip.text.x = element_text(size = 10, face = "bold")
  ) +
  labs(
    title = "Contraceptives and Abortion Trends between 2016 and 2023", 
    x = "Total Contraceptives per year", 
    y = "Total Abortion per year", 
  ) +
  annotate(geom = "text", label = "italic(R) ^ 2 == 0.7237", colour = "black", x = 888000, y = 14000,  parse = TRUE)
  
lm <- lm(data = contraceptive_abortion_yearly, total_abortion_per_year ~ total_contraceptives)
summary(lm)
  
```


### Contraceptive and pregnancy termination trends across NHS Scotland Health Boards

Negative trend in contraceptive usage can be seen accross all health boards (Fig. 3 and 4). Most of the health boards have very similar use and trend of short term contraception, except for Lothian, Dumfries and Galloway, and Shetland. While Lothian and Dumfries and Galloway have similar overall trend to other boards, Lothian has significantly lower dispensation of short-term contraception and Dumfries and Galloway has significantly higher. Shetland on the other hand, seems to have a steeper decline in short-term birth control use compared to all other boards. Interestlingly, it also showcases the steepest decline in long-term contraception use. There is more variability between health boards when it comes to long-term contraception. 
h
```{r}
# make a table with all health boards, for contraception and abortion

```



